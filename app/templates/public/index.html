{% extends "base.html" %}

{% block title %}Service Status{% endblock %}

{% block content %}
<div class="container mx-auto py-8 px-2 sm:px-4 md:px-8">
  <!-- Global Status Banner -->
  <div class="mb-6">
    <div class="bg-light-card dark:bg-dark-card rounded-xl shadow-lg p-6 border border-light-border dark:border-dark-border">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex items-center gap-4">
          <div class="flex-shrink-0">
            {% if status_icon == "success" %}
              <div class="w-16 h-16 rounded-full bg-status-up-light/20 dark:bg-status-up-dark/20 flex items-center justify-center">
                <svg class="w-8 h-8 text-status-up-light dark:text-status-up-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
            {% elif status_icon == "warning" %}
              <div class="w-16 h-16 rounded-full bg-status-degraded-light/20 dark:bg-status-degraded-dark/20 flex items-center justify-center">
                <svg class="w-8 h-8 text-status-degraded-light dark:text-status-degraded-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </div>
            {% elif status_icon == "error" %}
              <div class="w-16 h-16 rounded-full bg-status-down-light/20 dark:bg-status-down-dark/20 flex items-center justify-center">
                <svg class="w-8 h-8 text-status-down-light dark:text-status-down-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
            {% else %}
              <div class="w-16 h-16 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                <svg class="w-8 h-8 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
            {% endif %}
          </div>
          <div>
            <h1 class="text-2xl font-bold text-light-text dark:text-dark-text">{{ overall_status }}</h1>
            <p class="text-sm text-light-muted dark:text-dark-muted mt-1">
              {% if services|length > 0 %}
                Overall uptime: <span class="font-semibold text-light-text dark:text-dark-text">{{ uptime_percentage }}%</span>
                {% if last_updated %}
                  • Last updated: <span class="font-mono text-xs">{{ last_updated.strftime('%Y-%m-%d %H:%M:%S UTC') }}</span>
                {% endif %}
              {% else %}
                <span class="text-light-muted dark:text-dark-muted">No public services configured yet.</span>
              {% endif %}
            </p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          {% if region != 'N/A' %}
          <span class="px-3 py-1 rounded-full text-xs font-medium bg-light-secondary dark:bg-dark-secondary text-light-text dark:text-dark-text border border-light-border dark:border-dark-border">
            Region: {{ region }}
          </span>
          {% endif %}
          <span class="px-3 py-1 rounded-full text-xs font-medium {% if environment == 'Production' %}bg-status-up-light/20 dark:bg-status-up-dark/20 text-status-up-light dark:text-status-up-dark{% else %}bg-status-degraded-light/20 dark:bg-status-degraded-dark/20 text-status-degraded-light dark:text-status-degraded-dark{% endif %} border {% if environment == 'Production' %}border-status-up-light/50 dark:border-status-up-dark/50{% else %}border-status-degraded-light/50 dark:border-status-degraded-dark/50{% endif %}">
            {{ environment }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Active Incidents Banner -->
  {% if active_incidents %}
  <div class="mb-6">
    <div class="bg-status-down-light/10 dark:bg-status-down-dark/10 border border-status-down-light/50 dark:border-status-down-dark/50 rounded-xl p-4">
      <div class="flex items-start gap-3">
        <svg class="w-6 h-6 text-status-down-light dark:text-status-down-dark flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <div class="flex-1">
          <h3 class="font-semibold text-status-down-light dark:text-status-down-dark mb-2">Active Incidents</h3>
          {% for incident in active_incidents %}
          <div class="mb-2 last:mb-0">
            <div class="font-medium text-light-text dark:text-dark-text">{{ incident.title }}</div>
            {% if incident.details %}
            <div class="text-sm text-light-muted dark:text-dark-muted mt-1">{{ incident.details }}</div>
            {% endif %}
            <div class="text-xs text-light-muted dark:text-dark-muted mt-1">
              {{ incident.service.name }} • {{ incident.timestamp.strftime('%Y-%m-%d %H:%M UTC') }}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Status by Tag Groups -->
  {% if services_by_tag %}
  <div class="mb-6 space-y-6">
    {% for tag in public_tags %}
      {% if tag.name in services_by_tag %}
        {% set tag_services = services_by_tag[tag.name] %}
        {% set counts = tag_status_counts[tag.name] %}
        <div class="bg-light-card dark:bg-dark-card rounded-xl shadow-lg p-6 border border-light-border dark:border-dark-border">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <span class="px-3 py-1 rounded-full text-sm font-medium text-white" style="background-color: {{ tag.color }};">
                {{ tag.name|title }}
              </span>
              <span class="text-sm text-light-muted dark:text-dark-muted">
                {{ counts.up }}/{{ counts.total }} up
                {% if counts.down > 0 %}
                  <span class="text-status-down-light dark:text-status-down-dark">• {{ counts.down }} down</span>
                {% endif %}
                {% if counts.degraded > 0 %}
                  <span class="text-status-degraded-light dark:text-status-degraded-dark">• {{ counts.degraded }} degraded</span>
                {% endif %}
              </span>
            </div>
            <div class="text-sm font-semibold {% if counts.uptime_pct >= 99.9 %}text-status-up-light dark:text-status-up-dark{% elif counts.uptime_pct >= 95 %}text-status-degraded-light dark:text-status-degraded-dark{% else %}text-status-down-light dark:text-status-down-dark{% endif %}">
              {{ counts.uptime_pct }}% uptime
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for service in tag_services %}
            <div class="bg-light-bg dark:bg-dark-bg rounded-lg p-4 border border-light-border dark:border-dark-border">
              <div class="flex items-center justify-between mb-2">
                <span class="font-semibold text-light-text dark:text-dark-text">{{ service.name }}</span>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                  {% if service.status == 'up' %}bg-status-up-light/20 dark:bg-status-up-dark/20 text-status-up-light dark:text-status-up-dark
                  {% elif service.status == 'down' %}bg-status-down-light/20 dark:bg-status-down-dark/20 text-status-down-light dark:text-status-down-dark
                  {% else %}bg-status-degraded-light/20 dark:bg-status-degraded-dark/20 text-status-degraded-light dark:text-status-degraded-dark{% endif %}">
                  {{ service.status|capitalize }}
                </span>
              </div>
              {% if service.description %}
              <p class="text-xs text-light-muted dark:text-dark-muted">{{ service.description }}</p>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>
  {% endif %}

  <!-- Empty State -->
  {% if not services_by_tag and services|length == 0 %}
  <div class="mb-6">
    <div class="bg-light-card dark:bg-dark-card rounded-xl shadow-lg p-12 border border-light-border dark:border-dark-border text-center">
      <svg class="w-16 h-16 mx-auto text-light-muted dark:text-dark-muted mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h2 class="text-xl font-semibold text-light-text dark:text-dark-text mb-2">No Public Services Configured</h2>
      <p class="text-light-muted dark:text-dark-muted">
        Services need to be tagged as public-facing to appear on this dashboard.
      </p>
    </div>
  </div>
  {% endif %}

  <!-- Subscribe to Updates Section -->
  <div class="mb-6">
    <div class="bg-light-card dark:bg-dark-card rounded-xl shadow-lg p-6 border border-light-border dark:border-dark-border">
      <h2 class="text-lg font-semibold text-light-text dark:text-dark-text mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-light-primary dark:text-dark-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg>
        Subscribe to Updates
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- RSS Feed -->
        <div class="bg-light-bg dark:bg-dark-bg rounded-lg p-4 border border-light-border dark:border-dark-border">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-5 h-5 text-light-primary dark:text-dark-primary" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6.503 20.752c0 1.794-1.456 3.248-3.251 3.248-1.796 0-3.252-1.454-3.252-3.248 0-1.794 1.456-3.248 3.252-3.248 1.795.001 3.251 1.454 3.251 3.248zm-6.503-12.572v4.811c6.05.062 10.96 4.966 11.022 11.009h4.817c-.062-8.71-7.118-15.758-15.839-15.82zm0-3.368c10.58.046 19.152 8.594 19.183 19.188h4.817c-.03-13.231-10.755-23.954-24-24v4.812z"/>
            </svg>
            <span class="font-medium text-light-text dark:text-dark-text">RSS Feed</span>
          </div>
          <p class="text-sm text-light-muted dark:text-dark-muted mb-3">Get real-time updates via RSS</p>
          <a href="{{ url_for('public.rss_feed') }}" class="inline-flex items-center text-sm text-light-primary dark:text-dark-primary hover:underline">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
            Subscribe to feed.xml
          </a>
        </div>

        <!-- Email (Coming Soon) -->
        <div class="bg-light-bg dark:bg-dark-bg rounded-lg p-4 border border-light-border dark:border-dark-border opacity-60">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-5 h-5 text-light-muted dark:text-dark-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <span class="font-medium text-light-text dark:text-dark-text">Email</span>
            <span class="px-2 py-0.5 rounded text-xs bg-light-secondary dark:bg-dark-secondary text-light-muted dark:text-dark-muted">Coming Soon</span>
          </div>
          <p class="text-sm text-light-muted dark:text-dark-muted">Email notifications for incidents</p>
        </div>

        <!-- Webhook (Coming Soon) -->
        <div class="bg-light-bg dark:bg-dark-bg rounded-lg p-4 border border-light-border dark:border-dark-border opacity-60">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-5 h-5 text-light-muted dark:text-dark-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            <span class="font-medium text-light-text dark:text-dark-text">Webhook</span>
            <span class="px-2 py-0.5 rounded text-xs bg-light-secondary dark:bg-dark-secondary text-light-muted dark:text-dark-muted">Coming Soon</span>
          </div>
          <p class="text-sm text-light-muted dark:text-dark-muted">Custom webhook integrations</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
